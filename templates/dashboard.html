<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Dashboard - Loan Applications</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root{
            --bg: #0b1220;
            --panel: #0f172a;
            --muted: #94a3b8;
            --text: #e6eef8;
            --accent: #60a5fa;
            --accent-2: #a78bfa;
            --glass: rgba(255,255,255,0.03);
            --card-radius: 12px;
        }
        [data-theme="light"]{
            --bg: #f6f9fc;
            --panel: #ffffff;
            --muted: #64748b;
            --text: #0f172a;
            --accent: #2563eb;
            --accent-2: #d946ef;
            --glass: rgba(0,0,0,0.02);
        }

        html,body{min-height:100vh;margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:var(--bg);color:var(--text);display:flex;flex-direction:column}
        .wrap{max-width:1200px;margin:28px auto;padding:20px;flex:1}

        .top-row{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px}
        .brand{display:flex;gap:14px;align-items:center}
        .brand h1{font-size:20px;margin:0;background:linear-gradient(90deg,var(--accent),var(--accent-2));-webkit-background-clip:text;background-clip:text;color:transparent}

        .controls{display:flex;gap:10px;align-items:center}
        .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
        .btn-verify{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#07111a;box-shadow:0 8px 20px rgba(96,165,250,0.12)}
        .btn-ghost{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.04)}
        .btn-primary{background:var(--accent);color:#062235}

        .card{background:var(--panel);border-radius:var(--card-radius);padding:18px;box-shadow:0 6px 24px rgba(2,6,23,0.6);}

        .stats{display:flex;gap:12px}
        .stat{background:var(--glass);padding:10px 14px;border-radius:10px;min-width:140px}
        .stat .label{font-size:12px;color:var(--muted)}
        .stat .value{font-weight:700;font-size:18px}

        .table-wrap{margin-top:16px;overflow:auto;border-radius:10px}
        table{width:100%;border-collapse:collapse;background:transparent}
        thead th{position:sticky;top:0;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);backdrop-filter:blur(6px);padding:12px;text-align:left;color:var(--muted);font-size:13px}
        tbody td{padding:12px;border-bottom:1px solid rgba(255,255,255,0.03)}
        tbody tr{transition:background 0.15s}
        tbody tr:hover{background:rgba(255,255,255,0.02)}

        .search-row{display:flex;gap:12px;align-items:center;margin-top:12px}
        .search{flex:1;display:flex;align-items:center;background:var(--glass);padding:10px;border-radius:10px}
        .search input{border:0;background:transparent;outline:none;color:var(--text);width:100%;font-size:14px}

        .row-actions{display:flex;gap:8px}
        .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);font-size:13px;color:var(--muted)}

        @media(max-width:800px){.stats{flex-direction:column}.top-row{flex-direction:column;align-items:flex-start}}
        /* Password modal */
        .modal-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);z-index:9999}
        .modal-box{background:var(--panel);padding:18px;border-radius:12px;min-width:320px;box-shadow:0 12px 40px rgba(2,6,23,0.6);color:var(--text)}
        .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
        .modal-input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);outline:none}
    </style>
</head>
<body>
    <div class="wrap">
        <div class="top-row">
            <div class="brand"><i class="fas fa-th-large" style="font-size:20px;color:var(--accent)"></i><h1>Loan Applications</h1></div>
            <div class="controls">
                <a href="/" class="btn btn-verify" title="Verify documents"><i class="fas fa-check-circle"></i> Verify documents</a>
                <button id="themeToggleBtn" class="btn btn-ghost" title="Toggle theme"><i id="themeIcon" class="fas fa-sun"></i></button>
                <button id="logoutBtn" class="btn btn-primary"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </div>

        <div class="card">
            <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start">
                <div>
                    <div style="color:var(--muted);font-size:13px">Overview</div>
                    <div style="display:flex;gap:12px;margin-top:10px" class="stats">
                        <div class="stat"><div class="label">Total Applications</div><div class="value" id="stat-total">{{ applications|length }}</div></div>
                        <div class="stat"><div class="label">Recent</div><div class="value" id="stat-recent">{{ applications[:5]|length }}</div></div>
                    </div>
                </div>

                <div style="min-width:320px">
                    <div class="search-row">
                        <div class="search"><i class="fas fa-search" style="color:var(--muted);margin-right:8px"></i><input id="searchInput" placeholder="Search by name, contact or id..."></div>
                        <div class="pill">Showing <span id="shownCount">{{ applications|length }}</span></div>
                    </div>
                </div>
            </div>

            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th style="width:70px">ID</th>
                            <th>Timestamp</th>
                            <th>Full Name</th>
                            <th>Contact</th>
                            <th>Amount</th>
                            <th>Months</th>
                            <th>Interest %</th>
                            <th>Monthly</th>
                            <th style="width:160px">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="appsTable">
                        {% for a in applications %}
                        <tr data-app-id="{{ a.id }}">
                            <td>{{ a.id }}</td>
                            <td class="cell-timestamp">{{ a.timestamp }}</td>
                            <td class="cell-fullname">{{ a.full_name }}</td>
                            <td class="cell-contact">{{ a.contact }}</td>
                            <td class="cell-amount">{{ "PHP {:,.2f}".format(a.amount) }}</td>
                            <td class="cell-months">{{ a.months }}</td>
                            <td class="cell-interest">{{ a.interest_rate }}</td>
                            <td class="cell-monthly">{{ "PHP {:,.2f}".format(a.monthly_payment) }}</td>
                            <td>
                                <div class="row-actions">
                                    <button class="btn btn-ghost btn-edit" data-id="{{ a.id }}"><i class="fas fa-edit"></i> Edit</button>
                                    <button class="btn btn-ghost btn-delete" data-id="{{ a.id }}"><i class="fas fa-trash-alt"></i> Delete</button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>
    <footer class="site-footer" style="text-align:center;color:var(--muted);margin-top:14px;padding:12px 0">Â© Reserved 2025</footer>

    <script>
        // Initialize theme
        (function(){
            const saved = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', saved);
            const icon = document.getElementById('themeIcon');
            if(icon) icon.className = saved === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        })();

        document.getElementById('themeToggleBtn').addEventListener('click', function(){
            const html = document.documentElement;
            const current = html.getAttribute('data-theme') || 'dark';
            const next = current === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            const icon = document.getElementById('themeIcon');
            if(icon) icon.className = next === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async ()=>{
            try{ const res = await fetch('/logout', {method:'POST', headers:{'Accept':'text/html'}}); if(res.redirected){window.location.href = res.url;return;} window.location.href='/login'; }catch(e){window.location.href='/login'}
        });

        // Show password modal and return entered value (or null)
        function showPasswordModal(message){
            return new Promise(resolve=>{
                const modal = document.getElementById('passwordModal');
                const msg = document.getElementById('passwordModalMessage');
                const input = document.getElementById('passwordModalInput');
                const ok = document.getElementById('passwordModalOk');
                const cancel = document.getElementById('passwordModalCancel');
                msg.textContent = message || 'Enter admin password';
                input.value = '';
                modal.style.display = 'flex';
                input.focus();
                function cleanup(val){
                    modal.style.display = 'none';
                    ok.removeEventListener('click', onOk);
                    cancel.removeEventListener('click', onCancel);
                    input.removeEventListener('keydown', onKey);
                    resolve(val);
                }
                function onOk(){ cleanup(input.value || null); }
                function onCancel(){ cleanup(null); }
                function onKey(e){ if(e.key === 'Enter'){ onOk(); } else if(e.key === 'Escape'){ onCancel(); } }
                ok.addEventListener('click', onOk);
                cancel.addEventListener('click', onCancel);
                input.addEventListener('keydown', onKey);
            });
        }

        // Search/filter
        const searchInput = document.getElementById('searchInput');
        const appsTable = document.getElementById('appsTable');
        const shownCount = document.getElementById('shownCount');
        searchInput.addEventListener('input', ()=>{
            const q = searchInput.value.trim().toLowerCase();
            let shown = 0;
            document.querySelectorAll('#appsTable tr').forEach(r=>{
                const id = r.children[0].textContent.toLowerCase();
                const name = r.querySelector('.cell-fullname').textContent.toLowerCase();
                const contact = r.querySelector('.cell-contact').textContent.toLowerCase();
                if(!q || id.includes(q) || name.includes(q) || contact.includes(q)){
                    r.style.display = '';
                    shown++;
                } else { r.style.display = 'none'; }
            });
            shownCount.textContent = shown;
        });

        // Admin auth helper
        async function authorizeAdmin(password){
            try{ const res = await fetch('/authorize-admin', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({password})}); if(res.ok){const j=await res.json();return j.authorized;} }catch(e){console.error(e)} return false;
        }

        // Delete and Edit handlers (reuse existing prompts)
        document.querySelectorAll('.btn-delete').forEach(btn=>btn.addEventListener('click', async function(){
            const id = this.dataset.id;
            if(!confirm('Delete application #' + id + '?')) return;
            const pwd = await showPasswordModal('Enter admin password to confirm deletion:');
            if(pwd===null) return;
            const ok = await authorizeAdmin(pwd);
            if(!ok){ alert('Invalid admin password'); return; }
            try{
                const r = await fetch('/delete-application/' + id, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({password: pwd})});
                const j = await r.json();
                if(r.ok && j.success){
                    alert('Deleted'); const row = document.querySelector('tr[data-app-id="'+id+'"]'); if(row) row.remove();
                } else { alert('Failed: ' + (j.message||'unknown')) }
            }catch(e){console.error(e);alert('Delete failed')}
        }));

        document.querySelectorAll('.btn-edit').forEach(btn=>btn.addEventListener('click', async function(){
            const id = this.dataset.id;
            const row = document.querySelector('tr[data-app-id="'+id+'"]');
            if(!row) return;
            const currentName = row.querySelector('.cell-fullname').textContent.trim();
            const currentContact = row.querySelector('.cell-contact').textContent.trim();
            const currentAmountText = row.querySelector('.cell-amount').textContent.replace(/[^0-9.\-]/g,'');
            const currentMonths = row.querySelector('.cell-months').textContent.trim();
            const currentInterest = row.querySelector('.cell-interest').textContent.trim();
            const pwd = await showPasswordModal('Enter admin password to edit:');
            if(pwd===null) return;
            const ok = await authorizeAdmin(pwd);
            if(!ok){ alert('Invalid admin password'); return; }
            const newName = prompt('Full name:', currentName);
            if(newName===null) return;
            const newContact = prompt('Contact:', currentContact);
            if(newContact===null) return;
            const newAmount = prompt('Amount (numeric):', currentAmountText);
            if(newAmount===null) return;
            const newMonths = prompt('Months (integer):', currentMonths);
            if(newMonths===null) return;
            const newInterest = prompt('Annual interest (%):', currentInterest);
            if(newInterest===null) return;
            try{
                const payload = {password: pwd, full_name: newName, contact: newContact, amount: newAmount, months: newMonths, interest_rate: newInterest};
                const r = await fetch('/update-application/' + id, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
                const j = await r.json();
                if(r.ok && j.success){
                    alert('Updated');
                    row.querySelector('.cell-fullname').textContent = newName;
                    row.querySelector('.cell-contact').textContent = newContact;
                    row.querySelector('.cell-amount').textContent = 'PHP ' + parseFloat(newAmount).toLocaleString('en-PH', {minimumFractionDigits:2, maximumFractionDigits:2});
                    row.querySelector('.cell-months').textContent = newMonths;
                    row.querySelector('.cell-interest').textContent = newInterest;
                    const monthly = (function(){ const amt = parseFloat(newAmount)||0; const rrate = (parseFloat(newInterest)||0)/100/12; const m = (rrate===0? (amt/(parseInt(newMonths)||1)) : (amt * rrate)/(1 - Math.pow(1 + rrate, -(parseInt(newMonths)||1)))); return m; })();
                    row.querySelector('.cell-monthly').textContent = 'PHP ' + monthly.toLocaleString('en-PH', {minimumFractionDigits:2, maximumFractionDigits:2});
                } else { alert('Failed: ' + (j.message||'unknown')) }
            }catch(e){console.error(e);alert('Update failed')}
        }));

    </script>
</body>
</html>

<!-- Password modal markup -->
<div id="passwordModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true" aria-labelledby="passwordModalTitle">
        <div id="passwordModalTitle" style="font-weight:700;margin-bottom:8px">Admin Password</div>
        <div id="passwordModalMessage" style="color:var(--muted);margin-bottom:8px">Enter admin password</div>
        <input id="passwordModalInput" class="modal-input" type="password" autocomplete="current-password" />
        <div class="modal-actions">
            <button id="passwordModalCancel" class="btn btn-ghost">Cancel</button>
            <button id="passwordModalOk" class="btn btn-primary">OK</button>
        </div>
    </div>
</div>
